<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Создание персонажа</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; }
    .card { max-width: 560px; margin: 48px auto; background:#fff; border-radius:14px; padding:24px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type="text"], input[type="password"] { width:100%; padding:10px 12px; border:1px solid #dcdfe4; border-radius:10px; }
    .muted { color:#667085; font-size:12px; margin-top:6px; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; margin-left:6px; }
    .actions { display:flex; gap:12px; margin-top:16px; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .ghost { background:#eef2ff; }
    .danger { color:#b42318; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Создание персонажа</h2>

    <div>Бросок 1d8: <span id="roll" class="badge">—</span></div>
    <div class="muted">Определяет стихию.</div>
    <div style="margin-top:8px;">
      <button id="reroll" class="ghost">Перебросить</button>
    </div>
    <div style="margin-top:8px;">Стихия: <strong id="element">—</strong></div>

    <label>Ник (только кириллица, 2–30)
      <input id="nick" type="text" pattern="[А-Яа-яЁёІіЇїЄєҐґ]{2,30}" placeholder="Напр.: Орлан">
    </label>

    <label style="display:flex; align-items:center; gap:8px; margin-top:12px;">
      <input id="noPin" type="checkbox"> Регистрация без PIN
    </label>

    <div id="pinBox">
      <label>PIN (4–6 цифр)
        <input id="pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="Напр.: 1234">
      </label>
      <div class="muted">Если без PIN — вход будет только по нику.</div>
    </div>

    <div class="actions">
      <button id="create" class="primary">Зарегистрировать</button>
      <button id="back" class="ghost">Назад</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px;"></div>
    <div id="err" class="danger" style="margin-top:6px;"></div>
  </div>

  <script type="module">
    import "./firebase-app.js";              // подключаем общий модуль
    const { fbRegister } = window._fb;

    const map = {
      1: "Без элемента (можно выбрать позже)",
      2: "Огонь", 3: "Лёд", 4: "Вода",
      5: "Ветер", 6: "Земля", 7: "Молния",
      8: "Выбор любого элемента"
    };

    const rollEl = document.getElementById("roll");
    const elemEl = document.getElementById("element");
    const rerollBtn = document.getElementById("reroll");
    const nickEl = document.getElementById("nick");
    const noPinEl = document.getElementById("noPin");
    const pinEl = document.getElementById("pin");
    const createBtn = document.getElementById("create");
    const backBtn = document.getElementById("back");
    const msgEl = document.getElementById("msg");
    const errEl = document.getElementById("err");

    function d8(){ return Math.floor(Math.random()*8)+1; }
    function setRoll(n){ rollEl.textContent=String(n); elemEl.textContent=map[n]; }
    setRoll(d8());
    rerollBtn.onclick = () => setRoll(d8());
    noPinEl.onchange = () => { pinEl.disabled = noPinEl.checked; if (noPinEl.checked) pinEl.value=""; }
    function info(t){ msgEl.textContent=t||""; }
    function fail(t){ errEl.textContent=t||""; }

    createBtn.onclick = async () => {
      info("Регистрируем…"); fail("");
      try {
        const nick = (nickEl.value||"").trim();
        const noPin = !!noPinEl.checked;
        const pin = (pinEl.value||"").trim();
        await fbRegister({ nick, pin, noPin });
        info("Готово! Возврат к входу…");
        window.location.href="/login";
      } catch(e){ info(""); fail(e?.message || String(e)); }
    };
    backBtn.onclick = () => history.back();
  </script>
</body>
</html>
