<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Создание персонажа</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; }
    .card { max-width: 560px; margin: 48px auto; background:#fff; border-radius:14px; padding:24px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type="text"], input[type="password"] { width:100%; padding:10px 12px; border:1px solid #dcdfe4; border-radius:10px; }
    .muted { color:#667085; font-size:12px; margin-top:6px; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; margin-left:6px; }
    .actions { display:flex; gap:12px; margin-top:16px; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .ghost { background:#eef2ff; }
    .danger { color:#b42318; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Создание персонажа</h2>

    <div id="rollBox">
      <div>Бросок 1d8: <span id="roll" class="badge">—</span></div>
      <div class="muted">Результат определяет стихию.</div>
      <div style="margin-top:8px;">
        <button id="reroll" class="ghost">Перебросить</button>
      </div>
      <div style="margin-top:8px;">Стихия: <strong id="element">—</strong></div>
    </div>

    <label>Ник (лишь кириллица, 2–30)
      <input id="nick" type="text" pattern="[А-Яа-яЁёІіЇїЄєҐґ]{2,30}" placeholder="Напр.: Орлан">
    </label>

    <label style="display:flex; align-items:center; gap:8px; margin-top:12px;">
      <input id="noPin" type="checkbox"> Регистрация без PIN
    </label>

    <div id="pinBox">
      <label>PIN (4–6 цифр)
        <input id="pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="Напр.: 1234">
      </label>
      <div class="muted">Если отметите «без PIN», вход будет только по нику.</div>
    </div>

    <div class="actions">
      <button id="create" class="primary">Зарегистрировать</button>
      <button id="back" class="ghost">Назад к входу</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px;"></div>
    <div id="err" class="danger" style="margin-top:6px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

    // --- НАСТРОЙКА ---
    // локально (эмуляторы):
    const USE_EMULATORS = true;                 // поставь false для прод
    const PROJECT_ID = "demo-rpvo1";            // в проде замени на свой projectId

    const firebaseConfig = USE_EMULATORS ? {
      apiKey: "demo", authDomain: "demo.firebaseapp.com",
      projectId: PROJECT_ID, appId: "demo"
    } : {
      apiKey: "…", authDomain: "…", projectId: "…", appId: "…"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    if (USE_EMULATORS) connectFunctionsEmulator(functions, "127.0.0.1", 5001);

    // --- UI ---
    const rollEl = document.getElementById("roll");
    const elemEl = document.getElementById("element");
    const rerollBtn = document.getElementById("reroll");
    const nickEl = document.getElementById("nick");
    const noPinEl = document.getElementById("noPin");
    const pinEl = document.getElementById("pin");
    const createBtn = document.getElementById("create");
    const backBtn = document.getElementById("back");
    const msgEl = document.getElementById("msg");
    const errEl = document.getElementById("err");

    const map = {
      1: "Без элемента (можно выбрать позже)",
      2: "Огонь",
      3: "Лёд",
      4: "Вода",
      5: "Ветер",
      6: "Земля",
      7: "Молния",
      8: "Выбор любого элемента"
    };

    function d8() { return Math.floor(Math.random() * 8) + 1; }
    function setResult(n) {
      rollEl.textContent = String(n);
      elemEl.textContent = map[n];
    }

    // бросаем при открытии
    setResult(d8());
    rerollBtn.onclick = () => setResult(d8());

    noPinEl.onchange = () => {
      pinEl.disabled = noPinEl.checked;
      if (noPinEl.checked) pinEl.value = "";
    };

    function uiInfo(t) { msgEl.textContent = t || ""; }
    function uiErr(t) { errEl.textContent = t || ""; }

    // --- Регистрация в Firebase ---
    async function register() {
      uiErr(""); uiInfo("Создаём пользователя…");
      const nick = (nickEl.value || "").trim();
      const noPin = !!noPinEl.checked;
      const pin = (pinEl.value || "").trim();

      // клиентская проверка
      const NICK_RE = /^[А-Яа-яЁёІіЇїЄєҐґ]{2,30}$/;
      if (!NICK_RE.test(nick)) { uiErr("Ник: только кириллица (2–30)."); uiInfo(""); return; }
      if (!noPin && !/^\d{4,6}$/.test(pin)) { uiErr("PIN: 4–6 цифр или отметьте «без PIN»."); uiInfo(""); return; }

      const call = httpsCallable(functions, "registerUser");
      const res = await call({ nick, pin, noPin });   // отдаст custom token
      const token = res.data.token;
      await signInWithCustomToken(auth, token);

      uiInfo("Готово! Входим…");
      // здесь можно запомнить элемент броска (rollEl.textContent) в профиле Firestore
      // сейчас просто вернёмся на логин/домой:
      window.location.href = "/";  // или "/login"
    }

    createBtn.onclick = () => register().catch(e => { uiInfo(""); uiErr(e?.message || String(e)); });
    backBtn.onclick = () => history.back();
  </script>
</body>
</html>
